---
import Layout from "../../layouts/Layout.astro";
import Card from "../../components/primitives/Card.astro";
import Badge from "../../components/primitives/Badge.astro";
import ConvictionBar from "../../components/primitives/ConvictionBar.astro";
import NewsCard from "../../components/composed/NewsCard.astro";
import PriceChart from "../../components/islands/PriceChart";
import { getPicks, getStockDetail, getNewsForStock, formatChange, formatPrice, formatLargeNumber } from "../../data/report";
import type { StockPick, StockDetail } from "../../data/types";

export function getStaticPaths() {
  const allPicks = getPicks("all");

  return allPicks.map((pick) => ({
    params: { ticker: pick.ticker },
    props: { pick },
  }));
}

interface Props {
  pick: StockPick;
}

const { pick } = Astro.props;

// Get detailed stock data
const stockDetail = getStockDetail(pick.ticker);

// Get company news for this ticker
const companyNews = getNewsForStock(pick.ticker);

const timeframeLabels = {
  short: "Short-term",
  medium: "Medium-term",
  long: "Long-term",
};

const timeframeColors = {
  short: "info",
  medium: "caution",
  long: "bullish",
} as const;

function _formatPrice(price: number | undefined): string {
  if (price === undefined) return "-";
  return formatPrice(price);
}

function _formatLargeNumber(num: number | undefined): string {
  if (num === undefined) return "-";
  return formatLargeNumber(num);
}
---

<Layout title={`${pick.ticker} - ${pick.companyName}`} description={`${pick.companyName} (${pick.ticker}) analysis with price chart, investment thesis, risk factors, and key metrics.`}>
  <!-- 1. Back link -->
  <a
    href="/picks"
    class="inline-flex items-center gap-1 text-sm text-text-secondary hover:text-accent transition-colors mb-6"
  >
    ← Back to Picks
  </a>

  <!-- 2. Stock header -->
  <div class="bg-bg-surface border border-border rounded-lg p-6 mb-6">
    <div class="flex flex-col lg:flex-row lg:items-start justify-between gap-6">
      <!-- Left: Ticker, name, price -->
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-2">
          <h1 class="text-3xl font-bold text-text-primary font-mono">{pick.ticker}</h1>
          <Badge text={timeframeLabels[pick.timeframe]} variant={timeframeColors[pick.timeframe]} />
        </div>
        <p class="text-lg text-text-secondary mb-4">{pick.companyName}</p>

        <!-- Price and change -->
        <div class="flex items-baseline gap-3 mb-4">
          <span class="text-4xl font-bold text-text-primary">
            {_formatPrice(pick.currentPrice)}
          </span>
          <span
            class:list={[
              "text-lg font-medium flex items-center gap-1",
              pick.priceChange >= 0 ? "text-success" : "text-danger",
            ]}
          >
            <span>{pick.priceChange >= 0 ? "↑" : "↓"}</span>
            {formatChange(pick.priceChange)} ({formatChange(pick.priceChangePercent, true)})
          </span>
        </div>

        <!-- Conviction bar -->
        <div class="max-w-xs">
          <p class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-2">
            Conviction Score
          </p>
          <ConvictionBar score={pick.convictionScore} showLabel />
        </div>
      </div>

      <!-- Right: Entry/Target/Stop prices -->
      <div class="flex gap-6 lg:gap-8">
        {pick.entryPrice && (
          <div class="text-center">
            <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Entry</p>
            <p class="text-xl font-semibold text-text-primary">{_formatPrice(pick.entryPrice)}</p>
          </div>
        )}
        {pick.targetPrice && (
          <div class="text-center">
            <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Target</p>
            <p class="text-xl font-semibold text-success">{_formatPrice(pick.targetPrice)}</p>
          </div>
        )}
        {pick.stopLoss && (
          <div class="text-center">
            <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Stop</p>
            <p class="text-xl font-semibold text-danger">{_formatPrice(pick.stopLoss)}</p>
          </div>
        )}
      </div>
    </div>
  </div>

  <div class="grid lg:grid-cols-3 gap-6">
    <!-- Main content (2 cols) -->
    <div class="lg:col-span-2 space-y-6">
      <!-- 3. Price chart -->
      <Card title="Price Chart">
        <div class="h-[350px]">
          <PriceChart ticker={pick.ticker} height={350} client:visible />
        </div>
      </Card>

      <!-- 4. Thesis card -->
      <Card title="Investment Thesis">
        <p class="text-text-primary leading-relaxed text-base">{pick.thesis}</p>
      </Card>

      <!-- 5. Risk factors card -->
      <Card title="Risk Factors">
        {pick.riskFactors.length === 0 ? (
          <p class="text-text-secondary">No specific risk factors identified.</p>
        ) : (
          <ul class="space-y-3">
            {pick.riskFactors.map((risk) => (
              <li class="flex items-start gap-3">
                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-danger/15 text-danger flex items-center justify-center text-sm">!</span>
                <span class="text-text-primary">{risk}</span>
              </li>
            ))}
          </ul>
        )}
      </Card>
    </div>

    <!-- Sidebar (1 col) -->
    <div class="space-y-6">
      <!-- Key metrics -->
      {stockDetail?.fundamentals && (
        <Card title="Key Metrics">
          <div class="space-y-0">
            <div class="flex justify-between py-3 border-b border-border">
              <span class="text-text-secondary">Market Cap</span>
              <span class="font-medium text-text-primary">
                {_formatLargeNumber(pick.marketCap)}
              </span>
            </div>
            <div class="flex justify-between py-3 border-b border-border">
              <span class="text-text-secondary">P/E (Trailing)</span>
              <span class="font-medium text-text-primary">
                {stockDetail.fundamentals.peTrailing?.toFixed(1) ?? "-"}
              </span>
            </div>
            <div class="flex justify-between py-3 border-b border-border">
              <span class="text-text-secondary">P/E (Forward)</span>
              <span class="font-medium text-text-primary">
                {stockDetail.fundamentals.peForward?.toFixed(1) ?? "-"}
              </span>
            </div>
            <div class="flex justify-between py-3 border-b border-border">
              <span class="text-text-secondary">52W High</span>
              <span class="font-medium text-text-primary">
                {_formatPrice(stockDetail.fundamentals.fiftyTwoWeekHigh)}
              </span>
            </div>
            <div class="flex justify-between py-3 border-b border-border">
              <span class="text-text-secondary">52W Low</span>
              <span class="font-medium text-text-primary">
                {_formatPrice(stockDetail.fundamentals.fiftyTwoWeekLow)}
              </span>
            </div>
            {stockDetail.fundamentals.revenueGrowth !== undefined && (
              <div class="flex justify-between py-3 border-b border-border">
                <span class="text-text-secondary">Revenue Growth</span>
                <span class="font-medium text-text-primary">
                  {(stockDetail.fundamentals.revenueGrowth * 100).toFixed(1)}%
                </span>
              </div>
            )}
            {stockDetail.fundamentals.profitMargin !== undefined && (
              <div class="flex justify-between py-3">
                <span class="text-text-secondary">Profit Margin</span>
                <span class="font-medium text-text-primary">
                  {(stockDetail.fundamentals.profitMargin * 100).toFixed(1)}%
                </span>
              </div>
            )}
          </div>
        </Card>
      )}

      <!-- 6. Related news card -->
      <Card title="Related News">
        {companyNews.length === 0 ? (
          <p class="text-text-secondary text-sm py-4 text-center">No recent news for this stock.</p>
        ) : (
          <div class="space-y-3">
            {companyNews.slice(0, 5).map((news) => (
              <NewsCard news={news} compact />
            ))}
          </div>
        )}
      </Card>
    </div>
  </div>
</Layout>
