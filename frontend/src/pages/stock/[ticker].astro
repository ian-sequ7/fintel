---
import Layout from "../../layouts/Layout.astro";
import Card from "../../components/primitives/Card.astro";
import Badge from "../../components/primitives/Badge.astro";
import ConvictionBar from "../../components/primitives/ConvictionBar.astro";
import NewsCard from "../../components/composed/NewsCard.astro";
import PriceChart from "../../components/islands/PriceChart";
import { WatchlistButton } from "../../components/islands/WatchlistManager";
import { CompareButton } from "../../components/islands/CompareManager";
import PaperTradeButton from "../../components/islands/PaperTradeButton";
import { getPicks, getAllStocks, getNewsForStock, formatChange, formatPrice, formatLargeNumber } from "../../data/report";
import type { StockPick, StockDetail, LiteStock } from "../../data/types";
// Import stockDetails directly for SSG (it's split from report.json)
import stockDetailsData from "../../../public/data/stockDetails.json";

// Prerender this page statically at build time
export const prerender = true;

export function getStaticPaths() {
  // Type the imported data
  const stockDetails = stockDetailsData as Record<string, StockDetail>;
  const allPicks = getPicks("all");
  const allStocks = getAllStocks();

  // Create a map of ticker -> priceHistory from allStocks
  const priceHistoryByTicker = new Map(
    allStocks.map((s) => [s.ticker, s.priceHistory ?? []])
  );

  // Create a set of pick tickers for quick lookup
  const pickTickers = new Set(allPicks.map((p) => p.ticker));

  // Map picks to paths (full data) - include priceHistory from allStocks
  const pickPaths = allPicks.map((pick) => ({
    params: { ticker: pick.ticker },
    props: {
      stock: pick,
      isPick: true,
      priceHistory: priceHistoryByTicker.get(pick.ticker) ?? [],
      stockDetail: stockDetails[pick.ticker] ?? null,
    },
  }));

  // Map lite stocks (non-picks) to paths
  const litePaths = allStocks
    .filter((stock) => !pickTickers.has(stock.ticker))
    .map((stock) => ({
      params: { ticker: stock.ticker },
      props: {
        stock,
        isPick: false,
        priceHistory: stock.priceHistory ?? [],
        stockDetail: null,
      },
    }));

  return [...pickPaths, ...litePaths];
}

interface Props {
  stock: StockPick | LiteStock;
  isPick: boolean;
  priceHistory: import("../../data/types").PricePoint[];
  stockDetail: StockDetail | null;
}

const { stock, isPick, priceHistory, stockDetail } = Astro.props;
// Cast to StockPick for pick-specific fields (only accessed when isPick is true)
const pick = stock as StockPick;

// Get company news for this ticker
const companyNews = getNewsForStock(stock.ticker);

const timeframeLabels = {
  short: "Short-term",
  medium: "Medium-term",
  long: "Long-term",
};

const timeframeColors = {
  short: "info",
  medium: "caution",
  long: "bullish",
} as const;

function _formatPrice(price: number | undefined): string {
  if (price === undefined) return "-";
  return formatPrice(price);
}

function _formatLargeNumber(num: number | undefined): string {
  if (num === undefined) return "-";
  return formatLargeNumber(num);
}

// Calculate trade progress metrics
function _calculateTradeProgress() {
  const entry = pick.entryPrice;
  const target = pick.targetPrice;
  const stop = pick.stopLoss;
  const current = pick.currentPrice;

  if (!entry || !target) return null;

  const gainFromEntry = current - entry;
  const gainPctFromEntry = (gainFromEntry / entry) * 100;
  const potentialGain = target - entry;
  const progressToTarget = potentialGain > 0 ? Math.min(100, Math.max(0, ((current - entry) / potentialGain) * 100)) : 0;

  // Risk/reward ratio
  const riskAmount = stop ? entry - stop : entry * 0.1; // Assume 10% if no stop
  const rewardAmount = target - entry;
  const riskReward = riskAmount > 0 ? rewardAmount / riskAmount : 0;

  return {
    gainFromEntry,
    gainPctFromEntry,
    progressToTarget,
    riskReward,
    isInProfit: gainFromEntry >= 0,
    targetReached: current >= target,
    stopTriggered: stop ? current <= stop : false,
  };
}

const tradeProgress = isPick ? _calculateTradeProgress() : null;
---

<Layout title={`${stock.ticker} - ${stock.companyName}`} description={`${stock.companyName} (${stock.ticker}) stock analysis${isPick ? " with investment thesis, risk factors, and key metrics" : ""}.`}>
  <!-- 1. Back link -->
  <a
    href={isPick ? "/picks" : "/heatmap"}
    class="inline-flex items-center gap-1 text-sm text-text-secondary hover:text-accent transition-colors mb-6"
  >
    ← Back to {isPick ? "Picks" : "Heat Map"}
  </a>

  <!-- 2. Stock header -->
  <div class="bg-bg-surface border border-border rounded-lg p-6 mb-6">
    <div class="flex flex-col lg:flex-row lg:items-start justify-between gap-6">
      <!-- Left: Ticker, name, price -->
      <div class="flex-1">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-3">
            <h1 class="text-3xl font-bold text-text-primary font-mono">{stock.ticker}</h1>
            {isPick && <Badge text={timeframeLabels[pick.timeframe]} variant={timeframeColors[pick.timeframe]} />}
            {!isPick && <Badge text="S&P 500" variant="default" />}
          </div>
          <div class="flex items-center gap-2">
            <PaperTradeButton client:load ticker={stock.ticker} companyName={stock.companyName} currentPrice={stock.currentPrice} size="md" variant="secondary" />
            <WatchlistButton client:load ticker={stock.ticker} companyName={stock.companyName} size="md" variant="icon" />
            <CompareButton client:load ticker={stock.ticker} companyName={stock.companyName} size="md" />
          </div>
        </div>
        <p class="text-lg text-text-secondary mb-4">{stock.companyName}</p>

        <!-- Price and change -->
        <div class="flex items-baseline gap-3 mb-4">
          <span class="text-4xl font-bold text-text-primary">
            {_formatPrice(stock.currentPrice)}
          </span>
          <span
            class:list={[
              "text-lg font-medium flex items-center gap-1",
              stock.priceChange >= 0 ? "text-success" : "text-danger",
            ]}
          >
            <span>{stock.priceChange >= 0 ? "↑" : "↓"}</span>
            {formatChange(stock.priceChange)} ({formatChange(stock.priceChangePercent, true)})
          </span>
        </div>

        <!-- Conviction bar (picks only) -->
        {isPick && (
          <div class="max-w-xs">
            <p class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-2">
              Conviction Score
            </p>
            <ConvictionBar score={pick.convictionScore} showLabel />
          </div>
        )}
      </div>

      <!-- Right: Entry/Target/Stop prices (picks only) -->
      {isPick && (
        <div class="flex gap-6 lg:gap-8">
          {pick.entryPrice && (
            <div class="text-center">
              <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Entry</p>
              <p class="text-xl font-semibold text-text-primary">{_formatPrice(pick.entryPrice)}</p>
            </div>
          )}
          {pick.targetPrice && (
            <div class="text-center">
              <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Target</p>
              <p class="text-xl font-semibold text-success">{_formatPrice(pick.targetPrice)}</p>
            </div>
          )}
          {pick.stopLoss && (
            <div class="text-center">
              <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Stop</p>
              <p class="text-xl font-semibold text-danger">{_formatPrice(pick.stopLoss)}</p>
            </div>
          )}
        </div>
      )}
    </div>
  </div>

  <!-- Trade Progress Section -->
  {tradeProgress && (
    <div class="bg-bg-surface border border-border rounded-lg p-6 mb-6">
      <h2 class="text-lg font-semibold text-text-primary mb-4">Trade Progress</h2>

      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Performance since entry -->
        <div>
          <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Since Entry</p>
          <p class:list={[
            "text-2xl font-bold",
            tradeProgress.isInProfit ? "text-success" : "text-danger"
          ]}>
            {tradeProgress.isInProfit ? "+" : ""}{tradeProgress.gainPctFromEntry.toFixed(2)}%
          </p>
          <p class:list={[
            "text-sm",
            tradeProgress.isInProfit ? "text-success" : "text-danger"
          ]}>
            {tradeProgress.isInProfit ? "+" : ""}{formatChange(tradeProgress.gainFromEntry)}
          </p>
        </div>

        <!-- Progress to target -->
        <div>
          <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Progress to Target</p>
          <div class="flex items-center gap-3">
            <div class="flex-1 h-3 bg-bg-elevated rounded-full overflow-hidden">
              <div
                class:list={[
                  "h-full rounded-full transition-all",
                  tradeProgress.targetReached ? "bg-success" : tradeProgress.isInProfit ? "bg-accent" : "bg-danger"
                ]}
                style={`width: ${Math.max(0, tradeProgress.progressToTarget)}%`}
              />
            </div>
            <span class="text-lg font-bold text-text-primary">
              {Math.round(tradeProgress.progressToTarget)}%
            </span>
          </div>
          {tradeProgress.targetReached && (
            <p class="text-sm text-success font-medium mt-1">Target Reached!</p>
          )}
        </div>

        <!-- Risk/Reward ratio -->
        <div>
          <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Risk/Reward</p>
          <p class="text-2xl font-bold text-text-primary">
            1:{tradeProgress.riskReward.toFixed(1)}
          </p>
          <p class="text-sm text-text-secondary">
            {tradeProgress.riskReward >= 2 ? "Favorable" : tradeProgress.riskReward >= 1 ? "Neutral" : "Unfavorable"}
          </p>
        </div>

        <!-- Status -->
        <div>
          <p class="text-xs text-text-secondary uppercase tracking-wide mb-1">Status</p>
          {tradeProgress.targetReached ? (
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-success" />
              <span class="text-lg font-bold text-success">Target Hit</span>
            </div>
          ) : tradeProgress.stopTriggered ? (
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-danger" />
              <span class="text-lg font-bold text-danger">Stop Triggered</span>
            </div>
          ) : tradeProgress.isInProfit ? (
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-success animate-pulse" />
              <span class="text-lg font-bold text-success">In Profit</span>
            </div>
          ) : (
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-warning" />
              <span class="text-lg font-bold text-warning">Below Entry</span>
            </div>
          )}
        </div>
      </div>
    </div>
  )}

  <div class="grid lg:grid-cols-3 gap-6">
    <!-- Main content (2 cols) -->
    <div class="lg:col-span-2 space-y-6">
      <!-- 3. Price chart -->
      <Card title="Price Chart">
        <div class="h-[480px] overflow-hidden">
          {priceHistory.length > 0 ? (
            <PriceChart ticker={stock.ticker} data={priceHistory} height={400} client:visible />
          ) : (
            <div class="h-full flex items-center justify-center text-text-secondary">
              <div class="text-center">
                <p class="text-lg mb-2">Historical price data not available</p>
                <p class="text-sm">Chart data is being fetched. Try refreshing the page.</p>
              </div>
            </div>
          )}
        </div>
      </Card>

      <!-- 4. Thesis card (picks only) -->
      {isPick && pick.thesis && (
        <Card title="Investment Thesis">
          <p class="text-text-primary leading-relaxed text-base">{pick.thesis}</p>
        </Card>
      )}

      <!-- 5. Risk factors card (picks only) -->
      {isPick && (
        <Card title="Risk Factors">
          {pick.riskFactors.length === 0 ? (
            <p class="text-text-secondary">No specific risk factors identified.</p>
          ) : (
            <ul class="space-y-3">
              {pick.riskFactors.map((risk) => (
                <li class="flex items-start gap-3">
                  <span class="flex-shrink-0 w-6 h-6 rounded-full bg-danger/15 text-danger flex items-center justify-center text-sm">!</span>
                  <span class="text-text-primary">{risk}</span>
                </li>
              ))}
            </ul>
          )}
        </Card>
      )}

      <!-- Lite stock notice -->
      {!isPick && (
        <Card title="AI Analysis">
          <div class="text-center py-6">
            <p class="text-text-secondary mb-3">
              This stock is part of the S&P 500 index but hasn't been selected as an AI pick.
            </p>
            <a href="/picks" class="text-accent hover:underline">
              View AI-analyzed picks →
            </a>
          </div>
        </Card>
      )}
    </div>

    <!-- Sidebar (1 col) -->
    <div class="space-y-6">
      <!-- Key metrics - show for ALL stocks -->
      <Card title="Key Metrics">
        <div class="space-y-0">
          {/* Market Cap - available for all stocks */}
          <div class="flex justify-between py-3 border-b border-border">
            <span class="text-text-secondary">Market Cap</span>
            <span class="font-medium text-text-primary">
              {_formatLargeNumber(stock.marketCap)}
            </span>
          </div>
          {/* Volume - available for all stocks */}
          <div class="flex justify-between py-3 border-b border-border">
            <span class="text-text-secondary">Volume</span>
            <span class="font-medium text-text-primary">
              {_formatLargeNumber(stock.volume)}
            </span>
          </div>
          {/* Additional metrics only for picks with fundamentals */}
          {stockDetail?.fundamentals && (
            <>
              <div class="flex justify-between py-3 border-b border-border">
                <span class="text-text-secondary">P/E (Trailing)</span>
                <span class="font-medium text-text-primary">
                  {stockDetail.fundamentals.peTrailing?.toFixed(1) ?? "-"}
                </span>
              </div>
              <div class="flex justify-between py-3 border-b border-border">
                <span class="text-text-secondary">P/E (Forward)</span>
                <span class="font-medium text-text-primary">
                  {stockDetail.fundamentals.peForward?.toFixed(1) ?? "-"}
                </span>
              </div>
              <div class="flex justify-between py-3 border-b border-border">
                <span class="text-text-secondary">52W High</span>
                <span class="font-medium text-text-primary">
                  {_formatPrice(stockDetail.fundamentals.fiftyTwoWeekHigh)}
                </span>
              </div>
              <div class="flex justify-between py-3 border-b border-border">
                <span class="text-text-secondary">52W Low</span>
                <span class="font-medium text-text-primary">
                  {_formatPrice(stockDetail.fundamentals.fiftyTwoWeekLow)}
                </span>
              </div>
              {stockDetail.fundamentals.revenueGrowth !== undefined && (
                <div class="flex justify-between py-3 border-b border-border">
                  <span class="text-text-secondary">Revenue Growth</span>
                  <span class="font-medium text-text-primary">
                    {(stockDetail.fundamentals.revenueGrowth * 100).toFixed(1)}%
                  </span>
                </div>
              )}
              {stockDetail.fundamentals.profitMargin !== undefined && (
                <div class="flex justify-between py-3 border-b border-border">
                  <span class="text-text-secondary">Profit Margin</span>
                  <span class="font-medium text-text-primary">
                    {(stockDetail.fundamentals.profitMargin * 100).toFixed(1)}%
                  </span>
                </div>
              )}
              {stockDetail.fundamentals.priceToBook !== undefined && stockDetail.fundamentals.priceToBook !== null && (
                <div class="flex justify-between py-3 border-b border-border">
                  <span class="text-text-secondary">P/B Ratio</span>
                  <span class="font-medium text-text-primary">
                    {stockDetail.fundamentals.priceToBook.toFixed(2)}
                  </span>
                </div>
              )}
              {stockDetail.fundamentals.dividendYield !== undefined && stockDetail.fundamentals.dividendYield !== null && (
                <div class="flex justify-between py-3 border-b border-border">
                  <span class="text-text-secondary">Dividend Yield</span>
                  <span class="font-medium text-text-primary">
                    {stockDetail.fundamentals.dividendYield.toFixed(2)}%
                  </span>
                </div>
              )}
              {stockDetail.fundamentals.beta !== undefined && stockDetail.fundamentals.beta !== null && (
                <div class="flex justify-between py-3 border-b border-border">
                  <span class="text-text-secondary">Beta</span>
                  <span class="font-medium text-text-primary">
                    {stockDetail.fundamentals.beta.toFixed(2)}
                  </span>
                </div>
              )}
              {stockDetail.fundamentals.avgVolume !== undefined && (
                <div class="flex justify-between py-3">
                  <span class="text-text-secondary">Avg Volume</span>
                  <span class="font-medium text-text-primary">
                    {_formatLargeNumber(stockDetail.fundamentals.avgVolume)}
                  </span>
                </div>
              )}
            </>
          )}
        </div>
      </Card>

      <!-- 6. Related news card -->
      <Card title="Related News">
        {companyNews.length === 0 ? (
          <p class="text-text-secondary text-sm py-4 text-center">No recent news for this stock.</p>
        ) : (
          <div class="space-y-3">
            {companyNews.slice(0, 5).map((news) => (
              <NewsCard news={news} compact />
            ))}
          </div>
        )}
      </Card>
    </div>
  </div>
</Layout>
