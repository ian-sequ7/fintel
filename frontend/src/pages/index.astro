---
import Layout from "../layouts/Layout.astro";
import MetricCard from "../components/primitives/MetricCard.astro";
import Card from "../components/primitives/Card.astro";
import PickCard from "../components/composed/PickCard.astro";
import RiskCard from "../components/composed/RiskCard.astro";
import NewsCard from "../components/composed/NewsCard.astro";
import {
  getPicks,
  getMacroRisks,
  getMacroData,
  getNews,
  getGeneratedAt,
  formatRelativeTime,
  getSummary,
} from "../data/report";

// Load data
const summary = getSummary();
const macroData = getMacroData();
const allPicks = getPicks("all");
const macroRisks = getMacroRisks();
const latestNews = getNews("all");
const generatedAt = getGeneratedAt();

// Get top pick from each timeframe
const shortPicks = getPicks("short", "conviction", "desc");
const mediumPicks = getPicks("medium", "conviction", "desc");
const longPicks = getPicks("long", "conviction", "desc");

const topShort = shortPicks[0];
const topMedium = mediumPicks[0];
const topLong = longPicks[0];

// Calculate metrics
const avgConviction = allPicks.length > 0
  ? allPicks.reduce((sum, p) => sum + p.convictionScore, 0) / allPicks.length
  : 0;

const highRiskCount = macroRisks.filter((r) => r.severity === "high").length;
const newsCount = latestNews.length;

// Market sentiment display
const sentimentLabels = {
  up: "Bullish",
  down: "Bearish",
  flat: "Neutral",
};
---

<Layout title="Overview" description="Dashboard overview with market metrics, top stock picks, macro risks, and latest financial news.">
  <!-- Page header -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-text-primary">Dashboard Overview</h1>
    <p class="text-text-secondary">
      Last updated: {formatRelativeTime(generatedAt.toISOString())}
    </p>
  </div>

  <!-- 1. Metrics strip -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <MetricCard
      label="Market Sentiment"
      value={sentimentLabels[macroData.marketSentiment]}
      trend={macroData.marketSentiment === "up" ? "up" : macroData.marketSentiment === "down" ? "down" : "stable"}
    />
    <MetricCard
      label="Avg Conviction"
      value={Math.round(avgConviction * 10)}
      unit="/10"
    />
    <MetricCard
      label="High Risks"
      value={highRiskCount}
      trend={highRiskCount > 1 ? "down" : highRiskCount === 0 ? "up" : "stable"}
    />
    <MetricCard
      label="News Today"
      value={newsCount}
    />
  </div>

  <!-- 2. Top Picks section -->
  <section class="mb-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-text-primary">Top Picks by Timeframe</h2>
      <a href="/picks" class="text-sm text-accent hover:underline">
        View all →
      </a>
    </div>

    <div class="grid md:grid-cols-3 gap-4">
      <!-- Short-term -->
      <div>
        <p class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-2">Short-term</p>
        {topShort ? (
          <PickCard pick={topShort} compact />
        ) : (
          <Card>
            <p class="text-text-secondary text-sm text-center py-4">No short-term picks</p>
          </Card>
        )}
      </div>

      <!-- Medium-term -->
      <div>
        <p class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-2">Medium-term</p>
        {topMedium ? (
          <PickCard pick={topMedium} compact />
        ) : (
          <Card>
            <p class="text-text-secondary text-sm text-center py-4">No medium-term picks</p>
          </Card>
        )}
      </div>

      <!-- Long-term -->
      <div>
        <p class="text-xs font-medium text-text-secondary uppercase tracking-wide mb-2">Long-term</p>
        {topLong ? (
          <PickCard pick={topLong} compact />
        ) : (
          <Card>
            <p class="text-text-secondary text-sm text-center py-4">No long-term picks</p>
          </Card>
        )}
      </div>
    </div>
  </section>

  <!-- 3. Macro Risks section -->
  <section class="mb-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-text-primary">Key Headwinds</h2>
      <a href="/macro" class="text-sm text-accent hover:underline">
        Full analysis →
      </a>
    </div>

    {macroRisks.length === 0 ? (
      <Card>
        <p class="text-text-secondary text-center py-4">No significant risks identified.</p>
      </Card>
    ) : (
      <div class="grid md:grid-cols-3 gap-4">
        {macroRisks.slice(0, 3).map((risk) => (
          <RiskCard risk={risk} />
        ))}
      </div>
    )}
  </section>

  <!-- 4. Recent News section -->
  <section>
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-text-primary">Latest News</h2>
      <a href="/news" class="text-sm text-accent hover:underline">
        All news →
      </a>
    </div>

    {latestNews.length === 0 ? (
      <Card>
        <p class="text-text-secondary text-center py-4">No news articles available.</p>
      </Card>
    ) : (
      <div class="space-y-3">
        {latestNews.slice(0, 5).map((news) => (
          <NewsCard news={news} compact />
        ))}
      </div>
    )}
  </section>
</Layout>
