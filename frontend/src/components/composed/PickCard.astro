---
import Badge from "../primitives/Badge.astro";
import ConvictionBar from "../primitives/ConvictionBar.astro";
import Sparkline from "../islands/Sparkline";
import { CompareButton } from "../islands/CompareManager";
import { WatchlistButton } from "../islands/WatchlistManager";
import { formatChange } from "../../data/report";
import type { StockPick, PricePoint } from "../../data/types";

interface Props {
  pick: StockPick;
  priceHistory?: PricePoint[];
  compact?: boolean;
  class?: string;
}

const { pick, priceHistory, compact = false, class: className = "" } = Astro.props;

const timeframeLabels = {
  short: "Short-term",
  medium: "Medium-term",
  long: "Long-term",
};

// short=blue (accent), medium=purple (we'll use warning as closest), long=green (success)
const timeframeColors = {
  short: "info",
  medium: "caution",
  long: "bullish",
} as const;

function _formatPrice(price: number | undefined): string {
  if (price === undefined) return "-";
  return `$${price.toFixed(2)}`;
}

const priceChangePositive = pick.priceChange >= 0;
---

<a
  href={`/stock/${pick.ticker}`}
  class:list={[
    "block bg-bg-surface border border-border rounded-lg hover:border-accent hover:shadow-md transition-all",
    compact ? "p-3" : "p-4",
    className,
  ]}
>
  <!-- Header: Ticker + Timeframe + Compare -->
  <div class="flex items-start justify-between mb-2">
    <div class="flex items-center gap-2">
      <span class="font-mono text-lg font-bold text-accent hover:underline">
        {pick.ticker}
      </span>
      <Badge text={timeframeLabels[pick.timeframe]} variant={timeframeColors[pick.timeframe]} size="sm" />
    </div>
    {!compact && (
      <div class="flex items-center gap-1">
        <WatchlistButton client:load ticker={pick.ticker} companyName={pick.companyName} size="sm" />
        <CompareButton client:load ticker={pick.ticker} companyName={pick.companyName} size="sm" />
      </div>
    )}
  </div>

  <!-- Company name -->
  <p class="text-sm text-text-secondary mb-2">{pick.companyName}</p>

  <!-- Price with sparkline or change -->
  <div class="flex items-center justify-between gap-2 mb-3">
    <div class="flex items-baseline gap-2">
      <span class="text-xl font-semibold text-text-primary">
        {_formatPrice(pick.currentPrice)}
      </span>
      {!priceHistory && (
        <span
          class:list={[
            "text-sm font-medium flex items-center gap-0.5",
            priceChangePositive ? "text-success" : "text-danger",
          ]}
        >
          <span>{priceChangePositive ? "↑" : "↓"}</span>
          <span>{formatChange(pick.priceChangePercent, true)}</span>
        </span>
      )}
    </div>
    {priceHistory && priceHistory.length >= 2 && (
      <Sparkline
        client:load
        data={priceHistory.map(p => ({ time: p.time, close: p.close }))}
        width={80}
        height={32}
        showChange={true}
      />
    )}
  </div>

  <!-- Conviction bar -->
  <div class="mb-3">
    <ConvictionBar score={pick.convictionScore} size="sm" />
  </div>

  <!-- Thesis (truncated if compact) -->
  <p
    class:list={[
      "text-sm text-text-secondary",
      compact ? "line-clamp-1" : "line-clamp-2",
    ]}
  >
    {pick.thesis}
  </p>

  <!-- Risk factors (hidden if compact) -->
  {
    !compact && pick.riskFactors.length > 0 && (
      <div class="mt-3 flex flex-wrap gap-1">
        {pick.riskFactors.slice(0, 3).map((risk) => (
          <Badge text={risk} variant="bearish" size="sm" />
        ))}
      </div>
    )
  }

  <!-- Entry/Target/Stop prices -->
  {
    !compact && (pick.entryPrice || pick.targetPrice) && (
      <div class="mt-3 pt-3 border-t border-border flex items-center justify-between text-xs text-text-secondary">
        {pick.entryPrice && <span>Entry: {_formatPrice(pick.entryPrice)}</span>}
        {pick.targetPrice && <span class="text-success">Target: {_formatPrice(pick.targetPrice)}</span>}
        {pick.stopLoss && <span class="text-danger">Stop: {_formatPrice(pick.stopLoss)}</span>}
      </div>
    )
  }
</a>
