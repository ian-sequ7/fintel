---
import Badge from "../primitives/Badge.astro";
import { formatRelativeTime } from "../../data/report";
import type { NewsItem } from "../../data/types";

interface Props {
  news: NewsItem;
  compact?: boolean;
  class?: string;
}

const { news, compact = false, class: className = "" } = Astro.props;

// Category badge colors
const categoryColors = {
  market: "info",
  company: "neutral",
  macro: "caution",
  earnings: "bullish",
} as const;

const categoryLabels = {
  market: "Market",
  company: "Company",
  macro: "Macro",
  earnings: "Earnings",
};
---

<div
  class:list={[
    "bg-bg-surface border border-border rounded-lg hover:border-accent transition-colors",
    compact ? "p-3" : "p-4",
    className,
  ]}
>
  <div class="flex items-start gap-3">
    <div class="flex-1 min-w-0">
      <!-- Headline (external link) -->
      <a
        href={news.url}
        target="_blank"
        rel="noopener noreferrer"
        class:list={[
          "font-medium text-text-primary hover:text-accent transition-colors block",
          compact ? "text-sm line-clamp-1" : "line-clamp-2",
        ]}
      >
        {news.headline}
        <span class="inline-block ml-1 text-text-secondary text-xs">↗</span>
      </a>

      <!-- Excerpt (hidden if compact) -->
      {
        news.excerpt && !compact && (
          <p class="text-sm text-text-secondary mt-1 line-clamp-2">
            {news.excerpt}
          </p>
        )
      }

      <!-- Meta: Source + Time + Category + Tickers -->
      <div class="flex items-center flex-wrap gap-2 mt-2">
        <!-- Source badge -->
        <span class="text-xs font-medium text-text-secondary bg-bg-elevated px-2 py-0.5 rounded">
          {news.source}
        </span>

        <span class="text-xs text-text-secondary">·</span>

        <!-- Relative time -->
        <span class="text-xs text-text-secondary">
          {formatRelativeTime(news.publishedAt)}
        </span>

        <span class="text-xs text-text-secondary">·</span>

        <!-- Category badge -->
        <Badge text={categoryLabels[news.category]} variant={categoryColors[news.category]} size="sm" />

        <!-- Mentioned tickers (clickable, link to stock pages) -->
        {
          news.tickersMentioned.length > 0 && (
            <>
              <span class="text-xs text-text-secondary">·</span>
              {news.tickersMentioned.slice(0, compact ? 1 : 3).map((ticker) => (
                <a
                  href={`/stock/${ticker}`}
                  class="inline-flex items-center font-medium rounded-full border text-xs px-2 py-0.5 bg-accent/15 text-accent border-accent/30 hover:bg-accent/25 transition-colors"
                  onclick="event.stopPropagation()"
                >
                  {ticker}
                </a>
              ))}
            </>
          )
        }
      </div>
    </div>

    <!-- Relevance score (hidden if compact) -->
    {
      news.relevanceScore !== undefined && !compact && (
        <div class="flex-shrink-0">
          <div
            class:list={[
              "text-xs font-medium px-2 py-1 rounded",
              news.relevanceScore >= 0.8
                ? "bg-success/15 text-success"
                : news.relevanceScore >= 0.5
                  ? "bg-warning/15 text-warning"
                  : "bg-bg-elevated text-text-secondary",
            ]}
          >
            {Math.round(news.relevanceScore * 100)}%
          </div>
        </div>
      )
    }
  </div>
</div>
